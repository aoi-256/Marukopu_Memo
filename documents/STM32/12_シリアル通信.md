
# シリアル通信をしてみよう

今回は、シリアル通信という方法を用いてデータの送受信を行う

実際に操縦データなどを送り機体を動かすことにも使われている！

## 作業の概要

(1) シリアル通信に使うピンの設定をする

(2) TeraTermの設定を行う

(3) STMマイコンからデータを送信し、TeraTermで受信する

## シリアル通信とは

とても雑に簡単に説明すると『usbケーブルを使って、STMマイコンとパソコンの間でデータ通信をする』ことである

すごい適当に例を出すとこんな感じである(?)

STMマイコン『10文字分のデータ送るよ！データは 『1234567890』だよ！』

usb『データの中身を運ぶよ』

パソコン　 『10文字分のデータが来たよ！データは『1234567890』だね！これを画面に出力するよ!』

お互いにタイミングとかを一切考えずデータを投げつけているだけなので、たまにうまく受信できないときもある

他のマイコンでも使えるので覚えておくととっても便利（プログラムの書き方は違うから、そのマイコン名+シリアル通信で調べてみよう）

## ピンの設定

今回も初期状態で設定が終わっている

実際に確認したい場合は、プロジェクトが入っているファイルの一番下にある
（プロジェクト名）.iocというファイルを開いて左下あたりを見てみよう！

緑色になっているピンと横に書いてある文字の対応が以下のようになっていれば問題ない！

```
PA2 USART2_TX (送信用のピン）
PA3 USART2_RX (受信用のピン)
```

## プログラム

データをシリアル通信で送るためには、この関数を使う

```
HAL_UART_Transmit(&huart2, str,11,100);
```
1つ目の引数である&huart2は通信にuart2（ピンで設定されていたやつ）を使うよということを表現している

uart1を使いたい場合は、&huart1にしてあげればよい

（&hを付け忘れがちなので、気を付けよう！）

2つ目の引数であるstrは送りたいメッセージが入った変数を示している

ここでは、strは配列（文字が並んでいっぱい入っている変数）であり、abcdeという文章を送る時は
a, b, c, d, eのように分解されて一文字ずつの配列（並び）として扱われている

3つ目の引数では、この配列の長さ（分解した文字の数）を示している。

abcdeを送りたい場合は、5文字であるためここを5にすればよい

4つ目の引数は送るのに時間がかかった場合、何秒まで待つかを示している

単位はミリ秒であるので、この場合は最大0.1秒待ってくれる

#### 実際のコード

紹介した関数を使ってプログラムを書くと以下のようになる

uint8_t とは、符号なしの8桁の整数（2進数の8桁であるので、0~255の256種類の数字）を入れることができる変数のこと

（intが符号付32桁でプラスマイナスで1桁、数字で31桁分を使うので、intの亜種みたいなやつだよ）

アルファベットや数字や空白を0~255の数字に変換し、1文字分ずつ送っているという認識で大丈夫！
(数字の対応については補足に書いておくので、余裕があったら見るとおもしろいかも？）

今回はvoid loop();に何も書いていないので、最初に一回実行されて終わりになる

最初からもう一度実行したい場合は、STM32の青か黒かどっちかのボタンを押せばいい（わすれちゃった）

```
void init(){

	uint8_t str[] = "Hello World";
	HAL_UART_Transmit(&huart2, str,11,100);

}

void loop(){
  
}
```

## TeraTermの設定

PCとSTM32をUSBで繋いでいる状態で、環境構築で入れたTeraTermを開いてみる

画面に新しい接続というウィンドウが出てくるはず

（出てこない場合は、左上のファイル→新しい接続(N)を押してみよう)

出てきたウィンドウの下側のシリアル(E)を押して、STなんちゃらと書いてあるものを選択する

選択した後にokを押して、STM32のボタンを押して最初から実行すると、
先ほどのプログラムで送信したメッセージが表示されるはずである。

## 補足

文字を数字に変換するときのルールについてのざっくりとした説明をしておきます

ここではASCiiコード（アスキーコード）というものを利用している

覚える必要は一切ない（自動でやってくれるから）けど、実際の対応表のリンクを貼っておくので、気になる場合は見てね！

http://www3.nit.ac.jp/~tamura/ex2/ascii.html

### 補足の応用

大文字のアルファベットと小文字のアルファベットには、数字にして32の差があることがわかる

そのため、大文字と小文字を変換したいときは、ASCiiコードに変換した上で32を足したり引いたりするとできたりもする

基本使わないけど、プログラミングが好きな人は覚えておくといつか使うかも？？？

## おわりに

今回はシリアル通信のプログラム作成を行った！

シリアル通信は、これからの開発で毎回と言ってもいいほど使うので、確実に使えるようにしておこう！

次回はPWMと呼ばれるパルス信号を用いて、サーボモーターを動かしてみる

[次のページ](13_サーボモーター.md)

[STM32-メニュー](index.md)
