
# シリアル通信をしてみよう

今回は、シリアル通信という方法を用いてデータの送受信を行う

実際に操縦データなどを送り機体を動かすことにも使われている！

## 作業の概要

(1) シリアル通信に使うピンの設定をする

(2) TeraTermの設定を行う

(3) STMマイコンからデータを送信し、TeraTermで受信する

## シリアル通信とは

とても雑に簡単に説明すると『usbケーブルを使って、STMマイコンとパソコンの間でデータ通信をする』ことである

他の通信形式と比べて設定が楽であるが、通信速度とデータの精度はあんまりよくない

（普通に使う分には基本的に問題ないので安心してね）

## ピンの設定

今回も初期状態で設定が終わっている

実際に確認したい場合は、プロジェクトが入っているファイルの一番下にある
（プロジェクト名）.iocというファイルを開いて左下あたりを見てみよう！

赤枠で囲った、PA2とPA3が同じように割り当てられていれば大丈夫！
```
PA2 USART2_TX (送信用のピン）
PA3 USART2_RX (受信用のピン)
```
![スクリーンショット (161)](https://github.com/user-attachments/assets/06d524aa-d26b-4596-ba3d-173e87dc766e)

## 関数の解説

データをシリアル通信で送るために、HAL_UART_Transmit関数を使う

### HAL_UART_Transmit
```
HAL_UART_Transmit(&huart2, str,11,100);
```
今回も関数の引数について説明する
### 第1引数 &huart2
```
通信にuart2（ピンで設定されていたやつ）を割り当てていることを示している

uart1を使いたい場合は、&huart1にしてあげればよい

（&hを付け忘れがちなので、気を付けよう！）
```
### 第2引数 str
```
strは送りたいメッセージが入った変数を示している

ここでは、strは配列（文字が並んでいっぱい入っている変数）であり、abcdeという文章を送る時は
a, b, c, d, eのように分解されて一文字ずつの配列（並び）として扱われている
```
### 第3引数 11
```
この配列の長さ（分解した文字の数）を示している。

abcdeを送りたい場合は、5文字であるためここを5にすればよい
```
### 第4引数 100
```
送るのに時間がかかった場合、何秒まで待つかを示している

単位はミリ秒であるので、この場合は最大0.1秒待ってくれる

次の処理が迫っている時やエラーが起きた時も、この設定のおかげで助かることがある
```
## サンプルコード

今回は、プログラムの世界で定番の"Hello World"という文字を送信してみる

void loop();に何も書いていないので、最初に一回実行されて終わりになる

最初からもう一度実行したい場合は、STM32のRESETと書かれたボタンを押せばよい


### uint8_tについて

通信では、0と1（電圧が高いか低いか）しか使えないため、文字を数字(2進数)に変換して送っている

uint8_t というのは、int（整数を入れることのできる変数）の仲間で、2進数8桁で表すことのできる0~255の数字を入れることができる

今回の通信では、Hello Worldの文字を8桁の数字に変換して送っているということである（詳しくは補足へ）

```
void init(){

	uint8_t str[] = "Hello World"; //最初に説明したstrという名前の配列(四角い括弧で表している）に"Hello World"を入れている
	HAL_UART_Transmit(&huart2, str,11,100);//strの中身を送信
}

void loop(){
  
}
```

## TeraTermの設定

PCとSTM32をUSBで繋いでいる状態で、環境構築で入れたTeraTermを開いてみる

画面に新しい接続というウィンドウが出てくるはず

（出てこない場合は、左上のファイル→新しい接続(N)を押してみよう)

出てきたウィンドウの下側のシリアル(E)を押して、STなんちゃらと書いてあるものを選択する

選択した後にokを押して、STM32のRESETボタンを押して最初から実行すると、

先ほどのプログラムで送信したメッセージが表示されるはずである。

### 文字化けしたときの対処法

これは、データを送るタイミングと受信するタイミングがずれてしまっていることで起きている

設定(s)からシリアルポート(P)を選択して、スピード（E)を115200に変更しよう(STM32からの通信速度の初期値）

## やってみよう

uint8_t str[] = "Hello World"; の部分を参考にして、

新しいuint8_t の配列であるmessage[]を作成して、自分の好きな文字を入力してみよう

文字数（スペース込み）を数えて、HAL_UART_Transmit()で正しくすべての文字が送れるようにしよう！
```
void init(){

	uint8_t str[] = "Hello World"; //最初に説明したstrという名前の配列(四角い括弧で表している）に"Hello World"を入れている
	HAL_UART_Transmit(&huart2, str,11,100);//strの中身を送信

 	//上を参考に下を書いてみよう

 	uint8_t　 = "   "; 
	HAL_UART_Transmit(&huart2,  ,  ,100);
}

void loop(){

}
```
## おわりに

今回はシリアル通信のプログラム作成を行った！

シリアル通信は、これからの開発で毎回と言ってもいいほど使うので、確実に使えるようにしておこう！

次回はPWMと呼ばれるパルス信号を用いて、サーボモーターを動かしてみる

[次のページ](13_サーボモーター.md)

[STM32-メニュー](index.md)

## 補足

文字を数字に変換するときのルールについてのざっくりとした説明をしておきます

ここではASCiiコード（アスキーコード）というものを利用している

覚える必要は一切ない（自動でやってくれるから）けど、実際の対応表のリンクを貼っておくので、気になる場合は見てね！

http://www3.nit.ac.jp/~tamura/ex2/ascii.html
