# STM32でサーボを動かしてみる

## 作業の概要

(1) タイマー（後述）の設定をする

(2) パルスの出力（後述）の設定をする

(3) 出力とサーボモーターを接続し、信号を送る


## サーボのしくみ

### 配線について

サーボモーターには3本線がある

真ん中が5vになっているので、ここだけは絶対に間違えないでね

残りの2つは間違えても動かないだけなので、そこまでこわくないよ

・5V線（プラスをつなぐ）

・信号線(制御用の信号を送る）

・GND線（マイナスをつなぐ）

### 信号線について

パルス信号（on/offが一定の周期で切り替わる信号）の周期で回転角度を受け取っている

例えば、
```
500μs  → 0°

1500μs → 90°

2500μs → 180°
```
のような形である

基本的に線形変換するので、いくつか値を試せば送るパルスの周期を考えることができる

## ピンの設定

(1) PA8にTIM1_CH1を割り当てる

(2) 左のtimersからTIM1を選択する

(3) Prescralerの値を83にする(タイマーの分解能の設定、基本83固定で問題ない)

## プログラム

すべて、wrapper.cppのloop()の中に書いて繰り返し処理がされるようにしよう

紹介する2つの関数を順番にかけばちゃんと動くよ

### パルスを送るための関数

STM32ではtimerを使ってパルスを生成している

このパルスをサーボモーターの信号線に送ることで回転ができる

#### タイマーのスタート

この関数を使うことでタイマーを開始できる

タイマーを使う前に実行しよう

第1引数は、&h(設定したタイマーの番号）

第2引数は、設定したタイマー内のチャンネルである

```
HAL_TIM_PWM_Start(&htim1, TIM_CHANNEL_1);
```

#### パルスの生成

この関数を使うことで、サーボに送るためのパルスが生成できる

パルスは設定したタイマーが対応している、基板上のピンから直接取り出せる

第1、第2引数は、startの関数と同じ

第3引数は、整数型でパルスの周期(μs)を入力すればよい

最初は500、1500、2500と直接数値を入れて試してみるといいね

```
__HAL_TIM_SET_COMPARE(&htim1, TIM_CHANNEL_1, uint16_t(time));
```

## 回路

抵抗などを使わず、線3本のみで動かすことができる

#### 線の色をサーボモーターの配線の色と同じにしておくと、つなぎ間違いの事故を減らせるのでおすすめ

STM32IDE上にはPA5やPB8などと書いてあるが、マイコン上にはD5のようにしか書かれていない

これは、公式が上げている対応表を見ることで解決できる

リンク(ページ下にあるよ）→ https://os.mbed.com/platforms/ST-Nucleo-F446RE/

#### 3本のピンの接続先

GND → サーボのGND線（黒）

5v  → サーボの5v線 （赤・真ん中)

D7(TIM1_CH1/PA8を使っている場合) → サーボの信号線(黄色）←使っているタイマーとピンの関係を対応表で見てね

## おわりに

今回はサーボモーターを動かした

大会のミッションの中にある救援物資の投下や飛行機の動翼の制御に必要になる！

次回は、受信機を使ってデータを読み取る方法を説明する！

[次のページ](14_受信機でのデータ読み取り.md)

[STM32-メニュー](index.md)
